<html>
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/yamljs/0.2.8/yaml.js"></script>
<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script>

// This page updates the organisations.yaml file with information from Facebook.
// TODO: deal with organisations who have deleted their Facebook presence.

var database = {};

function dumpData()
{
  $('body').html(YAML.stringify(database, 3));
}

function updateDataFromFB(response)
{
  console.log("processing " + JSON.stringify(response));
  if (!response.username && response.id)
  {
    response.username = response.id;
  }

  if (response.username)
  {
    var orgname = response.username;
    for (var j = 0; j < database.organisations.length; j++)
    {
      if (database.organisations[j].facebook && orgname.toUpperCase() == ("" + database.organisations[j].facebook).toUpperCase())
      {
        if (response.posts && response.posts.data && response.posts.data.length > 0)
        {
          database.organisations[j].lastFacebookPost = response.posts.data[0].created_time;
          if (response.picture && response.picture.data && response.picture.data.url)
          {
            database.organisations[j].facebookIcon = response.picture.data.url;
          }
          if (response.about)
          {
            database.organisations[j].facebookDescription = response.about;
          }
        }
        else
        {
          console.log("no posts found for user " + orgname);
        }
      }
    }
  }
}

  window.fbAsyncInit = function() {
    FB.init({
      appId      : '745155608993451',
      xfbml      : true,
      version    : 'v2.8'
    });

    FB.login(function()
    {

      $.get("./organisations.yaml", function (data) {
        console.log(data);
        database = YAML.parse(data);

        console.log("Got " + database.organisations.length + " orgs.");
        for (var i = 0; i < database.organisations.length; i++)
        {
          if (database.organisations[i].facebook)
          {
            console.log("looking up " + database.organisations[i].facebook);
            FB.api('/' + database.organisations[i].facebook, {fields: 'id,username,posts{created_time},about'}, function (response) 
              {
                  updateDataFromFB(response);
              }
            );
          }
        }
      });
    }, {scope: ''});
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>

</head>
<body>
test
</body>
</html>